<%- include('../../components/header', { title: 'Locations' }) %>

<main class="h-screen m-auto">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-60 h-full">
      <%- include('../../components/template') %>
    </div>
    <!-- Content -->
    <div class="flex-1 p-6 overflow-y-auto pt-16">
      <div class="sm:flex sm:items-center px-8 pt-4">
        <%- include('../../components/pageTitle', {
          title: 'Locations',
          description: 'Manage datacenter locations for your nodes'
        }) %>
        <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
          <div class="flex gap-2">
            <button id="createButton" type="button" class="border border-neutral-800/20 block rounded-xl bg-white hover:bg-neutral-200 dark:hover:bg-neutral-300 text-neutral-800 px-3 py-2 text-center text-sm font-medium shadow-lg transition duration-300 focus:outline focus:outline-2 focus:outline-offset-2">
              Create New Location
            </button>
          </div>
        </div>
      </div>

      <div id="stats" class="grid grid-cols-1 md:grid-cols-2 gap-6 m-8">
        <div class="bg-white/5 rounded-xl p-6 shadow-lg border border-neutral-800/20">
          <h2 class="text-lg font-medium text-neutral-800 dark:text-white mb-2">Total Locations</h2>
          <p class="text-4xl font-normal text-neutral-800 dark:text-white"><%= locations.length %></p>
          <% if (locations.length > 0) { %>
          <p class="text-sm text-neutral-400 mt-2">Manage your datacenter locations</p>
          <% } else { %>
          <p class="text-sm text-neutral-400 mt-2">No locations available</p>
          <% } %>
        </div>
        <div class="bg-white/5 rounded-xl p-6 shadow-lg border border-neutral-800/20">
          <h2 class="text-lg font-medium text-neutral-800 dark:text-white mb-2">Node Distribution</h2>
          <p class="text-4xl font-normal text-neutral-800 dark:text-white">
            <%= locations.reduce((total, location) => total + location._count.nodes, 0) %>
          </p>
          <% if (locations.length > 0) { %>
            <p class="text-sm text-neutral-400 mt-2">
              Average nodes per location:
              <%= (locations.reduce((total, location) => total + location._count.nodes, 0) / locations.length).toFixed(2) %>
            </p>
          <% } else { %>
            <p class="text-sm text-neutral-400 mt-2">No nodes assigned to locations</p>
          <% } %>
        </div>
      </div>

      <!-- notifications -->
      <% if (req.query.err == "none") { %>
        <div class="mt-6 ml-8 mr-8">
          <div class="rounded-xl bg-emerald-600/20 dark:bg-emerald-800/10 px-4 py-6 shadow-lg border border-neutral-800/20">
            <div class="flex">
              <div class="flex-shrink-0 ml-1.5">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mt-2 text-emerald-400">
                  <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-5">
                <h3 class="text-sm font-medium text-emerald-400">Success!</h3>
                <p class="text-sm text-emerald-400/50">Action completed successfully</p>
              </div>
            </div>
          </div>
        </div>
      <% } %>

      <!-- Table of locations -->
      <div class="overflow-hidden shadow rounded-lg m-8 border border-neutral-800/20" id="locationTable">
        <table class="min-w-full divide-y divide-white/10">
          <thead class="bg-white/5">
            <tr>
              <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-medium text-neutral-800 dark:text-white sm:pl-6">Name</th>
              <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-medium text-neutral-800 dark:text-white sm:pl-6">Short Code</th>
              <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-medium text-neutral-800 dark:text-white sm:pl-6">Nodes</th>
              <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-medium text-neutral-800 dark:text-white sm:pl-6">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/5 bg-white/5">
            <% locations.forEach(function(location) { %>
              <tr class="hover:bg-white/[0.05] transition-colors clickable-row cursor-pointer" onclick="handleRowClick(event, '/admin/location/<%= location.id %>')">
                <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm sm:pl-6">
                  <div class="flex items-center">
                    <div class="font-medium text-neutral-800 dark:text-white"><%= location.name %></div>
                  </div>
                </td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-neutral-400"><%= location.shortCode || '-' %></td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-neutral-400"><%= location._count.nodes %></td>
                <td class="whitespace-nowrap px-3 py-4 text-sm">
                  <div class="flex gap-3">
                    <a href="/admin/location/<%= location.id %>">
                      <button type="button" class="rounded-xl bg-white border border-neutral-800/20 hover:bg-neutral-300 text-neutral-800 px-3 py-2 text-center text-sm font-medium shadow-lg transition">Edit</button>
                    </a>
                    <button onclick="deleteLocation('<%= location.id %>')" type="button" class="rounded-xl bg-red-600 px-3 py-2 text-center text-sm font-medium text-white shadow-lg hover:bg-red-500 transition">Remove</button>
                  </div>
                </td>
              </tr>
            <% }); %>
            <% if (locations.length === 0) { %>
              <tr>
                <td colspan="4" class="whitespace-nowrap py-4 pl-4 pr-3 text-sm text-center text-neutral-400 sm:pl-6">
                  No locations found. Create your first location to get started.
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</main>

<%- include('../../components/toast') %>

<script>
  function handleRowClick(event, url) {
    if (!['BUTTON', 'A'].includes(event.target.tagName)) {
      window.location = url;
    }
  }

  async function deleteLocation(locationId) {
    try {
      const response = await fetch(`/admin/location/${locationId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
      });

      const result = await response.json();

      if (response.ok) {
        showToast('Location successfully deleted', 'success');
        setTimeout(() => {
          window.location.reload();
        }, 1000);
      } else {
        showToast(result.message || 'Failed to delete location', 'error');
      }
    } catch (error) {
      console.error('Request failed:', error);
      showToast('An error occurred while deleting the location', 'error');
    }
  }

  document.getElementById('createButton').addEventListener('click', () => {
    window.location.href = '/admin/locations/create';
  });
</script>
