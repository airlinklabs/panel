<%- include('../../components/header', { title: 'Addons' }) %>
<%- include('../../components/toast') %>
<%- include('../../components/loadingPopup') %>

<main class="h-screen m-auto">
  <div class="flex h-screen">
    <div class="w-60 h-full">
      <%- include('../../components/template') %>
    </div>
    <div class="flex-1 p-6 overflow-y-auto pt-16">
      <div class="sm:flex sm:items-center px-8 pt-4">
        <div class="sm:flex-auto">
          <h1 class="text-base font-medium leading-6 text-white">Addons</h1>
          <p class="mt-1 tracking-tight text-sm text-neutral-500">Manage and discover panel addons</p>
        </div>
        <div class="mt-4 sm:ml-16 sm:mt-0 flex gap-2">
          <button id="reloadAddonsBtn" type="button" class="w-full md:w-auto rounded-xl bg-neutral-800 hover:bg-neutral-700 text-neutral-200 px-3 py-2 text-sm font-medium shadow-sm transition flex items-center gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
            </svg>
            Reload
          </button>
          <a href="/admin/addons/store" class="w-full md:w-auto rounded-xl bg-neutral-950 dark:bg-white hover:bg-neutral-300 text-neutral-200 dark:text-neutral-800 px-3 py-2 text-sm font-medium shadow-sm transition flex items-center gap-1.5">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 21v-7.5a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 .75.75V21m-4.5 0H2.36m11.14 0H18m0 0h3.64m-1.39 0V9.349M3.75 21V9.349m0 0a3.001 3.001 0 0 0 3.75-.615A2.993 2.993 0 0 0 9.75 9.75c.896 0 1.7-.393 2.25-1.016a2.993 2.993 0 0 0 2.25 1.016c.896 0 1.7-.393 2.25-1.015a3.001 3.001 0 0 0 3.75.614m-16.5 0a3.004 3.004 0 0 1-.621-4.72l1.189-1.19A1.5 1.5 0 0 1 5.378 3h13.243a1.5 1.5 0 0 1 1.06.44l1.19 1.189a3 3 0 0 1-.621 4.72M6.75 18h3.75a.75.75 0 0 0 .75-.75V13.5a.75.75 0 0 0-.75-.75H6.75a.75.75 0 0 0-.75.75v3.75c0 .414.336.75.75.75Z" />
            </svg>
            Browse Store
          </a>
        </div>
      </div>

      <!-- Tab nav -->
      <div class="px-8 mt-6">
        <div class="flex gap-1 border-b border-neutral-800">
          <a href="/admin/addons" class="px-4 py-2 text-sm font-medium text-white border-b-2 border-white -mb-px">Installed</a>
          <a href="/admin/addons/store" class="px-4 py-2 text-sm font-medium text-neutral-500 hover:text-neutral-300 transition -mb-px">Store</a>
        </div>
      </div>

      <div class="px-8 mt-5">
        <% if (!addonTableExists) { %>
          <div class="bg-amber-500/10 border border-amber-500/20 rounded-xl p-5 mb-6">
            <div class="flex gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-amber-500 flex-shrink-0 mt-0.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 3.014-1.874 2.148-3.374L16.5 7.5l-4.5-2.625L7.5 7.5l-5.803 10.126Z" />
              </svg>
              <div>
                <h3 class="text-sm font-medium text-amber-500">Database Migration Required</h3>
                <p class="mt-1 text-sm text-amber-400/80">The Addon table does not exist. Run database migrations to enable the addons system.</p>
              </div>
            </div>
          </div>
        <% } %>

        <% if (addons && addons.length > 0) { %>
          <div class="grid gap-3">
            <% addons.forEach(function(addon) { %>
              <div class="rounded-xl bg-neutral-900 p-5 flex flex-col sm:flex-row sm:items-center gap-4" data-addon-slug="<%= addon.slug %>">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2.5 flex-wrap">
                    <h3 class="text-sm font-semibold text-white"><%= addon.name %></h3>
                    <span class="text-xs text-neutral-500">v<%= addon.version %></span>
                    <% if (addon.enabled) { %>
                      <span class="status-badge inline-flex items-center rounded-full bg-emerald-500/15 text-emerald-400 px-2 py-0.5 text-xs font-medium">Enabled</span>
                    <% } else { %>
                      <span class="status-badge inline-flex items-center rounded-full bg-neutral-700/60 text-neutral-400 px-2 py-0.5 text-xs font-medium">Disabled</span>
                    <% } %>
                  </div>
                  <p class="mt-1 text-sm text-neutral-400 truncate"><%= addon.description || 'No description provided.' %></p>
                  <% if (addon.author) { %>
                    <p class="mt-1 text-xs text-neutral-600">by <%= addon.author %></p>
                  <% } %>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <button
                    type="button"
                    onclick="toggleAddonStatus('<%= addon.slug %>', <%= !addon.enabled %>)"
                    class="rounded-xl bg-neutral-800 hover:bg-neutral-700 text-neutral-200 px-3 py-1.5 text-xs font-medium transition"
                  >
                    <%= addon.enabled ? 'Disable' : 'Enable' %>
                  </button>
                </div>
              </div>
            <% }); %>
          </div>
        <% } else { %>
          <div class="rounded-xl bg-neutral-900 p-12 text-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" class="w-10 h-10 text-neutral-700 mx-auto mb-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 2.625c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125m16.5 2.625c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
            </svg>
            <h3 class="text-sm font-medium text-neutral-400">No addons installed</h3>
            <p class="mt-1.5 text-sm text-neutral-600">
              <% if (addonTableExists) { %>
                Browse the store to install addons, or drop folders into <code class="px-1 py-0.5 bg-neutral-800 rounded text-xs">storage/addons</code>.
              <% } else { %>
                Run database migrations to enable the addon system.
              <% } %>
            </p>
            <% if (addonTableExists) { %>
              <div class="mt-5">
                <a href="/admin/addons/store" class="inline-flex items-center gap-1.5 rounded-xl bg-neutral-950 dark:bg-white hover:bg-neutral-300 text-neutral-200 dark:text-neutral-800 px-4 py-2 text-sm font-medium shadow-sm transition">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 21v-7.5a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 .75.75V21m-4.5 0H2.36m11.14 0H18m0 0h3.64m-1.39 0V9.349M3.75 21V9.349m0 0a3.001 3.001 0 0 0 3.75-.615A2.993 2.993 0 0 0 9.75 9.75c.896 0 1.7-.393 2.25-1.016a2.993 2.993 0 0 0 2.25 1.016c.896 0 1.7-.393 2.25-1.015a3.001 3.001 0 0 0 3.75.614m-16.5 0a3.004 3.004 0 0 1-.621-4.72l1.189-1.19A1.5 1.5 0 0 1 5.378 3h13.243a1.5 1.5 0 0 1 1.06.44l1.19 1.189a3 3 0 0 1-.621 4.72M6.75 18h3.75a.75.75 0 0 0 .75-.75V13.5a.75.75 0 0 0-.75-.75H6.75a.75.75 0 0 0-.75.75v3.75c0 .414.336.75.75.75Z" />
                  </svg>
                  Browse Store
                </a>
              </div>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</main>

<script>
  function toggleAddonStatus(slug, enabled) {
    showLoadingPopup('Updating addon...', 'Applying changes...');

    fetch(`/admin/addons/toggle/${slug}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled: enabled.toString() }),
    })
    .then(r => r.json())
    .then(data => {
      hideLoadingPopup();
      if (data.success) {
        showToast('Addon updated', 'success');
        updateAddonUI(slug, enabled);
      } else {
        showToast(data.message || 'Failed to update addon', 'error');
      }
    })
    .catch(() => {
      hideLoadingPopup();
      showToast('An error occurred', 'error');
    });
  }

  function updateAddonUI(slug, enabled) {
    const card = document.querySelector(`[data-addon-slug="${slug}"]`);
    if (!card) return;

    const badge = card.querySelector('.status-badge');
    if (badge) {
      if (enabled) {
        badge.className = 'status-badge inline-flex items-center rounded-full bg-emerald-500/15 text-emerald-400 px-2 py-0.5 text-xs font-medium';
        badge.textContent = 'Enabled';
      } else {
        badge.className = 'status-badge inline-flex items-center rounded-full bg-neutral-700/60 text-neutral-400 px-2 py-0.5 text-xs font-medium';
        badge.textContent = 'Disabled';
      }
    }

    const btn = card.querySelector('button');
    if (btn) {
      btn.textContent = enabled ? 'Disable' : 'Enable';
      btn.onclick = () => toggleAddonStatus(slug, !enabled);
    }
  }

  document.getElementById('reloadAddonsBtn').addEventListener('click', () => {
    showLoadingPopup('Reloading addons...', 'Please wait...');
    fetch('/admin/addons/reload', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
      .then(r => r.json())
      .then(data => {
        hideLoadingPopup();
        showToast(data.message || (data.success ? 'Reloaded' : 'Failed'), data.success ? 'success' : 'error');
      })
      .catch(() => {
        hideLoadingPopup();
        showToast('An error occurred', 'error');
      });
  });
</script>

<%- include('../../components/footer') %>
